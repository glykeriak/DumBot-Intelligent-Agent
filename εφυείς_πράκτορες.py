# -*- coding: utf-8 -*-
"""Î•Ï†Ï…ÎµÎ¯Ï‚ Î ÏÎ¬ÎºÏ„Î¿ÏÎµÏ‚.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1g320nfZwmliN8uB8YPM6q0jj0T899mAa
"""

# Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ· 1
!pip install openai langchain langchain-openai langchain-community ipywidgets

# Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ· 2
!pip install gradio

# Î•Î¹ÏƒÎ±Î³Ï‰Î³Î­Ï‚ Î³Î¹Î± OpenAI + LangChain
from langchain_openai import ChatOpenAI
from langchain.prompts import ChatPromptTemplate
from google.colab import drive
from dotenv import load_dotenv
from openai import OpenAI
from IPython.display import display

# Widgets & Î´Î¹ÎµÏ€Î±Ï†Î®
import ipywidgets as widgets
import gradio as gr
import os

# Î£Ï…Î½Î´Î­Î¿Ï…Î¼Îµ Ï„Î¿ Google Drive Î³Î¹Î± Î½Î± Ï€Î¬ÏÎ¿Ï…Î¼Îµ Ï„Î¿ API key
# Î¤Î¿ API key Ï„Î¿Ï€Î¿Î¸ÎµÏ„ÎµÎ¯Ï„Î±Î¹ ÏƒÎµ .env Î±ÏÏ‡ÎµÎ¯Î¿ Î³Î¹Î± Î»ÏŒÎ³Î¿Ï…Ï‚ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚
drive.mount('/content/drive')
# Î¦Î¿ÏÏ„ÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Î¼Îµ Ï„Î¿ API key
load_dotenv('/content/drive/MyDrive/Colab Notebooks/api_key.env')

client = OpenAI(
    api_key=os.environ["OPENAI_API_KEY"],
    base_url="https://openrouter.ai/api/v1"
)

# ÎŸ LLM agent Ï€Î¿Ï… Î¸Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î³Î¹Î± ÏƒÏ…Î¶Î®Ï„Î·ÏƒÎ·
general_llm = ChatOpenAI(
    model="mistralai/mistral-7b-instruct",
    # ÎšÏÎ±Ï„Î¬Î¼Îµ Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¹ÎºÏŒÏ„Î·Ï„Î± Ï‡Î±Î¼Î·Î»Î¬ Î³Î¹Î± ÏƒÏ„Î±Î¸ÎµÏÏŒÏ„Î·Ï„Î± ÏƒÏ„Î¹Ï‚ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚
    temperature=0.2,
    # Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î¿ OpenRouter Ï‰Ï‚ endpoint
    openai_api_base="https://openrouter.ai/api/v1"
)

# UI Î¼Îµ gradio Î³Î¹Î± Ï„Î·Î½ ÎµÏ€Î¹Î»Î¿Î³Î® Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚
task_choice = gr.Radio(
    ["Î“ÎµÎ½Î¹ÎºÎ® Î£Ï…Î¶Î®Ï„Î·ÏƒÎ·", "Î£Ï…Î³Î³ÏÎ±Ï†Î® ÎšÏÎ´Î¹ÎºÎ±", "Î•ÎºÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰ÏƒÎ· ÎšÏÎ´Î¹ÎºÎ±", "Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· ÎšÏÎ´Î¹ÎºÎ±"],
    label="Î•Ï€Î­Î»ÎµÎ¾Îµ"
)

# Agent Î³Î¹Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÏÎ´Î¹ÎºÎ±
class CodeHelper:
    def __init__(self):
        self.chat = ChatOpenAI(
            model="mistralai/mistral-7b-instruct",
            temperature=0.2,
            openai_api_base="https://openrouter.ai/api/v1"
        )

    def create_function(self, description):
        prompt = ChatPromptTemplate.from_messages([
            ("system", "You are a senior developer. Write clean, correct, and efficient code based on the following description."),
            ("user", "Description:\n{description}")
        ])

        full_prompt = prompt.format_prompt(description=description)
        reply = self.chat.invoke(full_prompt.to_messages())
        return reply.content

# Agent Î³Î¹Î± Î´Î¹ÏŒÏÎ¸Ï‰ÏƒÎ· ÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰Î½
class CodeDebugger:
    def __init__(self):
        self.chat = ChatOpenAI(
            model="mistralai/mistral-7b-instruct",
            temperature=0.2,
            openai_api_base="https://openrouter.ai/api/v1"
        )

    def fix_errors(self, code):
        prompt = ChatPromptTemplate.from_messages([
            ("system", "You are a debugging expert. Find and fix any errors or issues in the following code."),
            ("user", "Code:\n{code}")
        ])

        full_prompt = prompt.format_prompt(code=code)
        reply = self.chat.invoke(full_prompt.to_messages())
        return reply.content

# Agent Î³Î¹Î± Ï„Î·Î½ Î±Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· Ï„Î¿Ï… ÎºÏÎ´Î¹ÎºÎ±
class CodeReviewer:
    def __init__(self):
        self.chat = ChatOpenAI(
            model="mistralai/mistral-7b-instruct",
            temperature=0.2,
            openai_api_base="https://openrouter.ai/api/v1"
        )

    def suggest_improvements(self, code):
        prompt = ChatPromptTemplate.from_messages([
            ("system", "You are an experienced code reviewer. Suggest improvements to enhance code quality, readability, and best practices."),
            ("user", "Code:\n{code}")
        ])

        full_prompt = prompt.format_prompt(code=code)
        reply = self.chat.invoke(full_prompt.to_messages())
        return reply.content

# ÎšÎµÎ½Ï„ÏÎ¹ÎºÏŒÏ‚ agent Î³Î¹Î± Ï„Î¿Î½ ÏƒÏ…Î½Ï„Î¿Î½Î¹ÏƒÎ¼ÏŒ Ï„Ï‰Î½ Ï…Ï€Î¿Î»Î¿Î¯Ï€Ï‰Î½
class CodingAssistant:
    def __init__(self):
        self.writer = CodeHelper()
        self.debugger = CodeDebugger()
        self.reviewer = CodeReviewer()

    def from_description(self, description):
        raw_code = self.writer.create_function(description)

        fixed_code = self.debugger.fix_errors(raw_code)

        feedback = self.reviewer.suggest_improvements(fixed_code)

        return raw_code, fixed_code, feedback

    def from_existing_code(self, code):
        fixed_code = self.debugger.fix_errors(code)
        feedback = self.reviewer.suggest_improvements(fixed_code)
        return fixed_code, feedback

assistant = CodingAssistant()

# Î£Ï…Î½Î¬ÏÏ„Î·ÏƒÎ· Ï€Î¿Ï… Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ Ï„Î·Î½ ÎµÎ¯ÏƒÎ¿Î´Î¿ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· ÎºÎ±Î¹ Î´Î¯Î½ÎµÎ¹ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚
def handle_input(message, mode, history=[]):

    messages = [{"role": "system", "content": "You are a friendly and intelligent assistant who remembers the conversation with the user."}]

    for user_msg, bot_msg in history:
        messages.append({"role": "user", "content": user_msg})
        messages.append({"role": "assistant", "content": bot_msg})

    if mode == "Î£Ï…Î³Î³ÏÎ±Ï†Î® ÎšÏÎ´Î¹ÎºÎ±":
        code, _, _ = assistant.from_description(message)
        messages.append({"role": "user", "content": f"Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®:\n{message}"})
        messages.append({"role": "assistant", "content": code})
        return code

    elif mode == "Î•ÎºÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰ÏƒÎ· ÎšÏÎ´Î¹ÎºÎ±":
        fixed_code, _ = assistant.from_existing_code(message)
        messages.append({"role": "user", "content": f"Î”Î¹ÏŒÏÎ¸Ï‰ÏƒÎµ Ï„Î¿Î½ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÎºÏÎ´Î¹ÎºÎ±:\n{message}"})
        messages.append({"role": "assistant", "content": fixed_code})
        return fixed_code

    elif mode == "Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· ÎšÏÎ´Î¹ÎºÎ±":
        _, feedback = assistant.from_existing_code(message)
        messages.append({"role": "user", "content": f"Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎµ Ï„Î¿Î½ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÎºÏÎ´Î¹ÎºÎ±:\n{message}"})
        messages.append({"role": "assistant", "content": feedback})
        return feedback

    elif mode == "Î“ÎµÎ½Î¹ÎºÎ® Î£Ï…Î¶Î®Ï„Î·ÏƒÎ·":
        messages.append({"role": "user", "content": message})
        response = general_llm.invoke(messages)
        return response.content

# UI Î¼Îµ gradio
with gr.Blocks() as app:
    gr.Markdown("## ğŸ˜ DumBot Ï„Î¿ ÎµÎ»ÎµÏ†Î±Î½Ï„Î¬ÎºÎ¹")

    mode = gr.Radio(
        ["Î“ÎµÎ½Î¹ÎºÎ® Î£Ï…Î¶Î®Ï„Î·ÏƒÎ·", "Î£Ï…Î³Î³ÏÎ±Ï†Î® ÎšÏÎ´Î¹ÎºÎ±", "Î•ÎºÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰ÏƒÎ· ÎšÏÎ´Î¹ÎºÎ±", "Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· ÎšÏÎ´Î¹ÎºÎ±"],
        label="Î•Ï€Î­Î»ÎµÎ¾Îµ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±"
    )

    chatbox = gr.Chatbot()
    user_input = gr.Textbox(label="Î“ÏÎ¬ÏˆÎµ ÎµÎ´Ï:")

    send_button = gr.Button("Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®")

    def reply(message, history, mode):
        response = handle_input(message, mode, history)
        history.append((message, response))
        return history, ""

    send_button.click(
        reply,
        inputs=[user_input, chatbox, mode],
        outputs=[chatbox, user_input]
    )

# Î•ÎºÎºÎ¯Î½Î·ÏƒÎ· Ï„Î·Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚
app.launch()